# ============================================
# INFRAESTRUCTURA COMO CÓDIGO - EL MUNDO FITNESS
# Arquitectura AWS Serverless con VPC Privada
# Estructura Modular
# ============================================

terraform {
  required_version = ">= 1.0"
  required_providers {
    aws = {
      source  = "hashicorp/aws"
      version = "~> 5.0"
    }
  }
}

provider "aws" {
  region = var.aws_region

  default_tags {
    tags = var.common_tags
  }
}

# ============================================
# DATA SOURCES
# ============================================

data "aws_caller_identity" "current" {}

data "aws_region" "current" {}

# ============================================
# MÓDULO VPC
# ============================================

module "vpc" {
  source = "./modules/vpc"

  project_name        = "${var.project_name}-${var.environment}"
  aws_region          = var.aws_region
  vpc_cidr            = var.vpc_cidr
  public_subnet_cidr  = var.public_subnet_cidr
  private_subnet_cidr = var.private_subnet_cidr
  availability_zone   = var.availability_zone
  tags                = var.common_tags
}

# ============================================
# MÓDULO DYNAMODB
# ============================================

module "dynamodb" {
  source = "./modules/dynamodb"

  project_name = "${var.project_name}-${var.environment}"
  billing_mode = var.dynamodb_billing_mode
  tags         = var.common_tags
}

# ============================================
# MÓDULO S3
# ============================================

module "s3" {
  source = "./modules/s3"

  project_name        = "${var.project_name}-${var.environment}"
  account_id          = data.aws_caller_identity.current.account_id
  block_public_access = true
  enable_versioning   = true
  tags                = var.common_tags
}

# ============================================
# MÓDULO LAMBDA
# ============================================

module "lambda" {
  source = "./modules/lambda"

  project_name          = "${var.project_name}-${var.environment}"
  environment           = var.environment
  vpc_id                = module.vpc.vpc_id
  private_subnet_id     = module.vpc.private_subnet_id
  usuarios_table_name   = module.dynamodb.usuarios_table_name
  historial_table_name  = module.dynamodb.historial_table_name
  dynamodb_table_arns   = module.dynamodb.all_table_arns
  lambda_runtime        = var.lambda_runtime
  lambda_memory_size    = var.lambda_memory_size
  lambda_timeout        = var.lambda_timeout
  tags                  = var.common_tags
}

# ============================================
# MÓDULO API GATEWAY
# ============================================

module "api_gateway" {
  source = "./modules/api-gateway"

  project_name                        = "${var.project_name}-${var.environment}"
  environment                         = var.environment
  subscription_control_function_name  = module.lambda.subscription_control_function_name
  subscription_control_invoke_arn     = module.lambda.subscription_control_invoke_arn
  access_control_function_name        = module.lambda.access_control_function_name
  access_control_invoke_arn           = module.lambda.access_control_invoke_arn
  notification_service_function_name  = module.lambda.notification_service_function_name
  notification_service_invoke_arn     = module.lambda.notification_service_invoke_arn
  tags                                = var.common_tags
}

# ============================================
# MÓDULO COGNITO
# ============================================

module "cognito" {
  source = "./modules/cognito"

  project_name = "${var.project_name}-${var.environment}"
  account_id   = data.aws_caller_identity.current.account_id
  tags         = var.common_tags
}


# Internet Gateway (Para la Subnet Pública)
resource "aws_internet_gateway" "main" {
  vpc_id = aws_vpc.main.id

  tags = {
    Name = "${var.project_name}-igw-${var.environment}"
  }
}

# ============================================
# SUBNET PÚBLICA (NAT Gateway + Internet Gateway)
# ============================================

resource "aws_subnet" "public" {
  vpc_id                  = aws_vpc.main.id
  cidr_block              = var.public_subnet_cidr
  availability_zone       = var.availability_zone
  map_public_ip_on_launch = true

  tags = {
    Name = "${var.project_name}-public-subnet-${var.environment}"
    Type = "Public"
  }
}

# Elastic IP para el NAT Gateway
resource "aws_eip" "nat" {
  domain = "vpc"

  tags = {
    Name = "${var.project_name}-nat-eip-${var.environment}"
  }

  depends_on = [aws_internet_gateway.main]
}

# NAT Gateway (Permite que Lambdas privadas salgan a Internet)
resource "aws_nat_gateway" "main" {
  allocation_id = aws_eip.nat.id
  subnet_id     = aws_subnet.public.id

  tags = {
    Name = "${var.project_name}-nat-gateway-${var.environment}"
  }

  depends_on = [aws_internet_gateway.main]
}

# Route Table Pública (conecta IGW)
resource "aws_route_table" "public" {
  vpc_id = aws_vpc.main.id

  route {
    cidr_block = "0.0.0.0/0"
    gateway_id = aws_internet_gateway.main.id
  }

  tags = {
    Name = "${var.project_name}-public-rt-${var.environment}"
  }
}

resource "aws_route_table_association" "public" {
  subnet_id      = aws_subnet.public.id
  route_table_id = aws_route_table.public.id
}

# ============================================
# SUBNET PRIVADA (Para las Lambdas)
# ============================================

resource "aws_subnet" "private" {
  vpc_id            = aws_vpc.main.id
  cidr_block        = var.private_subnet_cidr
  availability_zone = var.availability_zone

  tags = {
    Name = "${var.project_name}-private-subnet-${var.environment}"
    Type = "Private"
  }
}

# Route Table Privada (conecta NAT Gateway para salida a Internet)
resource "aws_route_table" "private" {
  vpc_id = aws_vpc.main.id

  route {
    cidr_block     = "0.0.0.0/0"
    nat_gateway_id = aws_nat_gateway.main.id
  }

  tags = {
    Name = "${var.project_name}-private-rt-${var.environment}"
  }
}

resource "aws_route_table_association" "private" {
  subnet_id      = aws_subnet.private.id
  route_table_id = aws_route_table.private.id
}

# ============================================
# 2. VPC ENDPOINTS (Gateway Endpoints)
# Los Gateway Endpoints permiten acceso privado a S3 y DynamoDB
# sin necesidad de salir a Internet (sin cargo adicional)
# ============================================

# VPC Endpoint para S3 (conectado a la Route Table privada)
resource "aws_vpc_endpoint" "s3" {
  vpc_id            = aws_vpc.main.id
  service_name      = "com.amazonaws.${var.aws_region}.s3"
  vpc_endpoint_type = "Gateway"
  route_table_ids   = [aws_route_table.private.id]

  tags = {
    Name = "${var.project_name}-s3-endpoint-${var.environment}"
  }
}

# VPC Endpoint para DynamoDB (conectado a la Route Table privada)
resource "aws_vpc_endpoint" "dynamodb" {
  vpc_id            = aws_vpc.main.id
  service_name      = "com.amazonaws.${var.aws_region}.dynamodb"
  vpc_endpoint_type = "Gateway"
  route_table_ids   = [aws_route_table.private.id]

  tags = {
    Name = "${var.project_name}-dynamodb-endpoint-${var.environment}"
  }
}

# ============================================
# 3. SECURITY GROUPS
# ============================================

# Security Group para las Lambdas (permite salida HTTPS)
resource "aws_security_group" "lambda" {
  name        = "${var.project_name}-lambda-sg-${var.environment}"
  description = "Security group para funciones Lambda"
  vpc_id      = aws_vpc.main.id

  # Regla de salida: Permite HTTPS hacia Internet (via NAT Gateway)
  egress {
    from_port   = 443
    to_port     = 443
    protocol    = "tcp"
    cidr_blocks = ["0.0.0.0/0"]
    description = "Permitir HTTPS hacia Internet"
  }

  # Regla de salida: Permite HTTP (si es necesario)
  egress {
    from_port   = 80
    to_port     = 80
    protocol    = "tcp"
    cidr_blocks = ["0.0.0.0/0"]
    description = "Permitir HTTP hacia Internet"
  }

  tags = {
    Name = "${var.project_name}-lambda-sg-${var.environment}"
  }
}

# ============================================
# 4. DYNAMODB
# Tres tablas: Usuarios, Pagos, Historial_Asistencia
# ============================================

# Tabla de Usuarios
resource "aws_dynamodb_table" "usuarios" {
  name         = "${var.project_name}-usuarios-${var.environment}"
  billing_mode = var.dynamodb_billing_mode
  hash_key     = "userId"

  attribute {
    name = "userId"
    type = "S"
  }

  attribute {
    name = "email"
    type = "S"
  }

  global_secondary_index {
    name            = "EmailIndex"
    hash_key        = "email"
    projection_type = "ALL"
  }

  tags = {
    Name = "${var.project_name}-usuarios-${var.environment}"
  }
}

# Tabla de Pagos
resource "aws_dynamodb_table" "pagos" {
  name         = "${var.project_name}-pagos-${var.environment}"
  billing_mode = var.dynamodb_billing_mode
  hash_key     = "pagoId"
  range_key    = "timestamp"

  attribute {
    name = "pagoId"
    type = "S"
  }

  attribute {
    name = "timestamp"
    type = "N"
  }

  attribute {
    name = "userId"
    type = "S"
  }

  global_secondary_index {
    name            = "UserIdIndex"
    hash_key        = "userId"
    range_key       = "timestamp"
    projection_type = "ALL"
  }

  tags = {
    Name = "${var.project_name}-pagos-${var.environment}"
  }
}

# Tabla de Historial de Asistencia
resource "aws_dynamodb_table" "historial_asistencia" {
  name         = "${var.project_name}-historial-asistencia-${var.environment}"
  billing_mode = var.dynamodb_billing_mode
  hash_key     = "asistenciaId"
  range_key    = "timestamp"

  attribute {
    name = "asistenciaId"
    type = "S"
  }

  attribute {
    name = "timestamp"
    type = "N"
  }

  attribute {
    name = "userId"
    type = "S"
  }

  global_secondary_index {
    name            = "UserIdIndex"
    hash_key        = "userId"
    range_key       = "timestamp"
    projection_type = "ALL"
  }

  tags = {
    Name = "${var.project_name}-historial-asistencia-${var.environment}"
  }
}

# ============================================
# 5. S3 BUCKET (Para el Frontend)
# ============================================

resource "aws_s3_bucket" "frontend" {
  bucket = "${var.project_name}-frontend-${var.environment}-${data.aws_caller_identity.current.account_id}"

  tags = {
    Name = "${var.project_name}-frontend-${var.environment}"
  }
}

# Configuración de Website Hosting
resource "aws_s3_bucket_website_configuration" "frontend" {
  bucket = aws_s3_bucket.frontend.id

  index_document {
    suffix = "index.html"
  }

  error_document {
    key = "error.html"
  }
}

# Bloquear acceso público (usar CloudFront en producción)
resource "aws_s3_bucket_public_access_block" "frontend" {
  bucket = aws_s3_bucket.frontend.id

  block_public_acls       = true
  block_public_policy     = true
  ignore_public_acls      = true
  restrict_public_buckets = true
}

# Versionado del bucket
resource "aws_s3_bucket_versioning" "frontend" {
  bucket = aws_s3_bucket.frontend.id

  versioning_configuration {
    status = "Enabled"
  }
}

# ============================================
# 6. IAM ROLE PARA LAMBDAS
# ============================================

# Policy Document que permite a Lambda asumir el rol
data "aws_iam_policy_document" "lambda_assume_role" {
  statement {
    effect = "Allow"

    principals {
      type        = "Service"
      identifiers = ["lambda.amazonaws.com"]
    }

    actions = ["sts:AssumeRole"]
  }
}

# Rol IAM para las funciones Lambda
resource "aws_iam_role" "lambda_execution" {
  name               = "${var.project_name}-lambda-execution-role-${var.environment}"
  assume_role_policy = data.aws_iam_policy_document.lambda_assume_role.json

  tags = {
    Name = "${var.project_name}-lambda-role-${var.environment}"
  }
}

# Adjuntar política básica de Lambda (logs de CloudWatch)
resource "aws_iam_role_policy_attachment" "lambda_basic" {
  role       = aws_iam_role.lambda_execution.name
  policy_arn = "arn:aws:iam::aws:policy/service-role/AWSLambdaBasicExecutionRole"
}

# Adjuntar política para acceso a VPC
resource "aws_iam_role_policy_attachment" "lambda_vpc" {
  role       = aws_iam_role.lambda_execution.name
  policy_arn = "arn:aws:iam::aws:policy/service-role/AWSLambdaVPCAccessExecutionRole"
}

# Política personalizada para acceso a DynamoDB
resource "aws_iam_role_policy" "lambda_dynamodb" {
  name = "${var.project_name}-lambda-dynamodb-policy-${var.environment}"
  role = aws_iam_role.lambda_execution.id

  policy = jsonencode({
    Version = "2012-10-17"
    Statement = [
      {
        Effect = "Allow"
        Action = [
          "dynamodb:GetItem",
          "dynamodb:PutItem",
          "dynamodb:UpdateItem",
          "dynamodb:DeleteItem",
          "dynamodb:Query",
          "dynamodb:Scan"
        ]
        Resource = [
          aws_dynamodb_table.usuarios.arn,
          aws_dynamodb_table.pagos.arn,
          aws_dynamodb_table.historial_asistencia.arn,
          "${aws_dynamodb_table.usuarios.arn}/index/*",
          "${aws_dynamodb_table.pagos.arn}/index/*",
          "${aws_dynamodb_table.historial_asistencia.arn}/index/*"
        ]
      }
    ]
  })
}

# ============================================
# 7. FUNCIONES LAMBDA (Placeholder Node.js)
# ============================================

# Crear archivo ZIP placeholder para las Lambdas
data "archive_file" "lambda_placeholder" {
  type        = "zip"
  output_path = "${path.module}/lambda_placeholder.zip"

  source {
    content  = <<-EOF
      exports.handler = async (event) => {
        console.log('Event:', JSON.stringify(event, null, 2));
        return {
          statusCode: 200,
          headers: {
            'Content-Type': 'application/json',
            'Access-Control-Allow-Origin': '*'
          },
          body: JSON.stringify({
            message: 'Lambda function placeholder',
            timestamp: new Date().toISOString()
          })
        };
      };
    EOF
    filename = "index.js"
  }
}

# Lambda 1: Subscription Control
resource "aws_lambda_function" "subscription_control" {
  filename         = data.archive_file.lambda_placeholder.output_path
  function_name    = "${var.project_name}-subscription-control-${var.environment}"
  role             = aws_iam_role.lambda_execution.arn
  handler          = "index.handler"
  source_code_hash = data.archive_file.lambda_placeholder.output_base64sha256
  runtime          = var.lambda_runtime
  memory_size      = var.lambda_memory_size
  timeout          = var.lambda_timeout

  # Configuración de VPC (Subnet Privada)
  vpc_config {
    subnet_ids         = [aws_subnet.private.id]
    security_group_ids = [aws_security_group.lambda.id]
  }

  environment {
    variables = {
      USUARIOS_TABLE = aws_dynamodb_table.usuarios.name
      ENVIRONMENT    = var.environment
    }
  }

  tags = {
    Name = "${var.project_name}-subscription-control-${var.environment}"
  }
}

# Lambda 2: Access Control
resource "aws_lambda_function" "access_control" {
  filename         = data.archive_file.lambda_placeholder.output_path
  function_name    = "${var.project_name}-access-control-${var.environment}"
  role             = aws_iam_role.lambda_execution.arn
  handler          = "index.handler"
  source_code_hash = data.archive_file.lambda_placeholder.output_base64sha256
  runtime          = var.lambda_runtime
  memory_size      = var.lambda_memory_size
  timeout          = var.lambda_timeout

  # Configuración de VPC (Subnet Privada)
  vpc_config {
    subnet_ids         = [aws_subnet.private.id]
    security_group_ids = [aws_security_group.lambda.id]
  }

  environment {
    variables = {
      HISTORIAL_TABLE = aws_dynamodb_table.historial_asistencia.name
      USUARIOS_TABLE  = aws_dynamodb_table.usuarios.name
      ENVIRONMENT     = var.environment
    }
  }

  tags = {
    Name = "${var.project_name}-access-control-${var.environment}"
  }
}

# Lambda 3: Notification Service
resource "aws_lambda_function" "notification_service" {
  filename         = data.archive_file.lambda_placeholder.output_path
  function_name    = "${var.project_name}-notification-service-${var.environment}"
  role             = aws_iam_role.lambda_execution.arn
  handler          = "index.handler"
  source_code_hash = data.archive_file.lambda_placeholder.output_base64sha256
  runtime          = var.lambda_runtime
  memory_size      = var.lambda_memory_size
  timeout          = var.lambda_timeout

  # Configuración de VPC (Subnet Privada)
  vpc_config {
    subnet_ids         = [aws_subnet.private.id]
    security_group_ids = [aws_security_group.lambda.id]
  }

  environment {
    variables = {
      USUARIOS_TABLE = aws_dynamodb_table.usuarios.name
      ENVIRONMENT    = var.environment
    }
  }

  tags = {
    Name = "${var.project_name}-notification-service-${var.environment}"
  }
}

# ============================================
# 8. API GATEWAY (HTTP API)
# ============================================

resource "aws_apigatewayv2_api" "main" {
  name          = "${var.project_name}-api-${var.environment}"
  protocol_type = "HTTP"
  description   = "API HTTP para El Mundo Fitness"

  cors_configuration {
    allow_origins = ["*"]
    allow_methods = ["GET", "POST", "PUT", "DELETE", "OPTIONS"]
    allow_headers = ["*"]
    max_age       = 300
  }

  tags = {
    Name = "${var.project_name}-api-${var.environment}"
  }
}

# Stage de API Gateway
resource "aws_apigatewayv2_stage" "main" {
  api_id      = aws_apigatewayv2_api.main.id
  name        = var.environment
  auto_deploy = true

  tags = {
    Name = "${var.project_name}-api-stage-${var.environment}"
  }
}

# Integración Lambda 1: Subscription Control
resource "aws_apigatewayv2_integration" "subscription_control" {
  api_id           = aws_apigatewayv2_api.main.id
  integration_type = "AWS_PROXY"
  integration_uri  = aws_lambda_function.subscription_control.invoke_arn
  integration_method        = "POST"
  payload_format_version    = "2.0"
}

resource "aws_apigatewayv2_route" "subscription_control" {
  api_id    = aws_apigatewayv2_api.main.id
  route_key = "POST /subscription"
  target    = "integrations/${aws_apigatewayv2_integration.subscription_control.id}"
}

resource "aws_lambda_permission" "subscription_control" {
  statement_id  = "AllowAPIGatewayInvoke"
  action        = "lambda:InvokeFunction"
  function_name = aws_lambda_function.subscription_control.function_name
  principal     = "apigateway.amazonaws.com"
  source_arn    = "${aws_apigatewayv2_api.main.execution_arn}/*/*"
}

# Integración Lambda 2: Access Control
resource "aws_apigatewayv2_integration" "access_control" {
  api_id           = aws_apigatewayv2_api.main.id
  integration_type = "AWS_PROXY"
  integration_uri  = aws_lambda_function.access_control.invoke_arn
  integration_method        = "POST"
  payload_format_version    = "2.0"
}

resource "aws_apigatewayv2_route" "access_control" {
  api_id    = aws_apigatewayv2_api.main.id
  route_key = "POST /access"
  target    = "integrations/${aws_apigatewayv2_integration.access_control.id}"
}

resource "aws_lambda_permission" "access_control" {
  statement_id  = "AllowAPIGatewayInvoke"
  action        = "lambda:InvokeFunction"
  function_name = aws_lambda_function.access_control.function_name
  principal     = "apigateway.amazonaws.com"
  source_arn    = "${aws_apigatewayv2_api.main.execution_arn}/*/*"
}

# Integración Lambda 3: Notification Service
resource "aws_apigatewayv2_integration" "notification_service" {
  api_id           = aws_apigatewayv2_api.main.id
  integration_type = "AWS_PROXY"
  integration_uri  = aws_lambda_function.notification_service.invoke_arn
  integration_method        = "POST"
  payload_format_version    = "2.0"
}

resource "aws_apigatewayv2_route" "notification_service" {
  api_id    = aws_apigatewayv2_api.main.id
  route_key = "POST /notification"
  target    = "integrations/${aws_apigatewayv2_integration.notification_service.id}"
}

resource "aws_lambda_permission" "notification_service" {
  statement_id  = "AllowAPIGatewayInvoke"
  action        = "lambda:InvokeFunction"
  function_name = aws_lambda_function.notification_service.function_name
  principal     = "apigateway.amazonaws.com"
  source_arn    = "${aws_apigatewayv2_api.main.execution_arn}/*/*"
}

# ============================================
# 9. AMAZON COGNITO USER POOL
# ============================================

resource "aws_cognito_user_pool" "main" {
  name = "${var.project_name}-user-pool-${var.environment}"

  # Configuración de atributos
  username_attributes      = ["email"]
  auto_verified_attributes = ["email"]

  # Políticas de contraseña
  password_policy {
    minimum_length    = 8
    require_lowercase = true
    require_numbers   = true
    require_symbols   = true
    require_uppercase = true
  }

  # Configuración de verificación de email
  verification_message_template {
    default_email_option = "CONFIRM_WITH_CODE"
    email_subject        = "El Mundo Fitness - Código de Verificación"
    email_message        = "Tu código de verificación es {####}"
  }

  # Configuración de MFA (opcional)
  mfa_configuration = "OPTIONAL"

  tags = {
    Name = "${var.project_name}-user-pool-${var.environment}"
  }
}

# Cliente de Cognito User Pool
resource "aws_cognito_user_pool_client" "main" {
  name         = "${var.project_name}-client-${var.environment}"
  user_pool_id = aws_cognito_user_pool.main.id

  generate_secret                      = false
  allowed_oauth_flows_user_pool_client = true
  allowed_oauth_flows                  = ["code", "implicit"]
  allowed_oauth_scopes                 = ["phone", "email", "openid", "profile"]
  callback_urls                        = ["http://localhost:3000/callback"]
  logout_urls                          = ["http://localhost:3000/logout"]

  supported_identity_providers = ["COGNITO"]

  explicit_auth_flows = [
    "ALLOW_USER_PASSWORD_AUTH",
    "ALLOW_REFRESH_TOKEN_AUTH",
    "ALLOW_USER_SRP_AUTH"
  ]
}

# Domain de Cognito
resource "aws_cognito_user_pool_domain" "main" {
  domain       = "${var.project_name}-${var.environment}-${data.aws_caller_identity.current.account_id}"
  user_pool_id = aws_cognito_user_pool.main.id
}

# ============================================
# DATA SOURCES
# ============================================

data "aws_caller_identity" "current" {}
