version: '3.8'

services:
  # ============================================
  # GRAFANA - Monitoreo de CloudWatch
  # ============================================
  grafana:
    image: grafana/grafana:latest
    container_name: elmundo-fitness-grafana
    restart: unless-stopped
    
    # Puertos
    ports:
      - "3000:3000"
    
    # Variables de Entorno
    environment:
      # Admin credentials (cambiar en producción)
      - GF_SECURITY_ADMIN_USER=admin
      - GF_SECURITY_ADMIN_PASSWORD=ElMundoFitness2024!
      
      # Configuración de servidor
      - GF_SERVER_ROOT_URL=http://localhost:3000
      - GF_SERVER_DOMAIN=localhost
      
      # Desactivar registro anónimo
      - GF_USERS_ALLOW_SIGN_UP=false
      
      # CloudWatch Plugin (viene incluido)
      - GF_INSTALL_PLUGINS=
      
      # AWS Credentials para CloudWatch
      # IMPORTANTE: Configurar estas variables antes de ejecutar
      - AWS_ACCESS_KEY_ID=${AWS_ACCESS_KEY_ID}
      - AWS_SECRET_ACCESS_KEY=${AWS_SECRET_ACCESS_KEY}
      - AWS_REGION=${AWS_REGION:-us-east-1}
      
      # Logs
      - GF_LOG_MODE=console
      - GF_LOG_LEVEL=info
    
    # Volúmenes persistentes
    volumes:
      # Datos de Grafana (dashboards, datasources, usuarios)
      - grafana-data:/var/lib/grafana
      
      # Configuración de provisioning (datasources y dashboards)
      - ./grafana/provisioning:/etc/grafana/provisioning
      
      # Dashboards personalizados
      - ./grafana/dashboards:/var/lib/grafana/dashboards
    
    # Healthcheck
    healthcheck:
      test: ["CMD", "wget", "--spider", "-q", "http://localhost:3000/api/health"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 40s
    
    # Red
    networks:
      - monitoring
    
    # Labels
    labels:
      - "com.elmundofitness.description=Grafana Dashboard para CloudWatch"
      - "com.elmundofitness.project=el-mundo-fitness"

  # ============================================
  # JENKINS - CI/CD Pipeline
  # ============================================
  jenkins:
    image: jenkins/jenkins:lts
    container_name: elmundo-fitness-jenkins
    restart: unless-stopped
    
    # Puertos
    ports:
      - "8080:8080"  # Puerto web de Jenkins
      - "50000:50000"  # Puerto para agentes
    
    # Variables de Entorno
    environment:
      - JENKINS_ADMIN_PASSWORD=${JENKINS_ADMIN_PASSWORD:-admin}
      - JAVA_OPTS=-Djenkins.install.runSetupWizard=true
      # - CASC_JENKINS_CONFIG=/var/jenkins_home/casc_configs/jenkins.yaml
      - AWS_ACCESS_KEY_ID=${AWS_ACCESS_KEY_ID}
      - AWS_SECRET_ACCESS_KEY=${AWS_SECRET_ACCESS_KEY}
      - AWS_REGION=${AWS_REGION:-us-east-1}
      - GITHUB_TOKEN=${GITHUB_TOKEN}
    
    # Volúmenes persistentes
    volumes:
      # Datos de Jenkins
      - jenkins-data:/var/jenkins_home
      
      # Configuración JCasC (Jenkins Configuration as Code)
      - ./jenkins.yaml:/var/jenkins_home/casc_configs/jenkins.yaml:ro
      
      # Lista de plugins a instalar
      - ./plugins.txt:/usr/share/jenkins/ref/plugins.txt:ro
      
      # Socket de Docker para ejecutar contenedores (Windows)
      - //var/run/docker.sock:/var/run/docker.sock
    
    # Healthcheck
    healthcheck:
      test: ["CMD-SHELL", "curl -f http://localhost:8080/login || exit 1"]
      interval: 30s
      timeout: 10s
      retries: 5
      start_period: 90s
    
    # Red
    networks:
      - monitoring
    
    # Labels
    labels:
      - "com.elmundofitness.description=Jenkins CI/CD Server"
      - "com.elmundofitness.project=el-mundo-fitness"
    
    # Usuario para acceder a Docker socket
    user: root

  # ============================================
  # OPCIONAL: Prometheus para métricas locales
  # ============================================
  # prometheus:
  #   image: prom/prometheus:latest
  #   container_name: elmundo-fitness-prometheus
  #   restart: unless-stopped
  #   ports:
  #     - "9090:9090"
  #   volumes:
  #     - ./prometheus/prometheus.yml:/etc/prometheus/prometheus.yml
  #     - prometheus-data:/prometheus
  #   command:
  #     - '--config.file=/etc/prometheus/prometheus.yml'
  #     - '--storage.tsdb.path=/prometheus'
  #     - '--web.console.libraries=/usr/share/prometheus/console_libraries'
  #     - '--web.console.templates=/usr/share/prometheus/consoles'
  #   networks:
  #     - monitoring

# ============================================
# VOLÚMENES
# ============================================
volumes:
  grafana-data:
    driver: local
    name: elmundo-fitness-grafana-data
  
  jenkins-data:
    driver: local
    name: elmundo-fitness-jenkins-data
  
  # prometheus-data:
  #   driver: local
  #   name: elmundo-fitness-prometheus-data

# ============================================
# RED
# ============================================
networks:
  monitoring:
    driver: bridge
    name: elmundo-fitness-monitoring
