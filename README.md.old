# ğŸ‹ï¸ El Mundo Fitness - Infraestructura como CÃ³digo (IaC)

Proyecto de Infraestructura como CÃ³digo usando **Terraform** con arquitectura **modular** siguiendo las mejores prÃ¡cticas de AWS.

---

## ğŸ“‹ Tabla de Contenidos

- [Arquitectura](#-arquitectura)
- [Estructura del Proyecto](#-estructura-del-proyecto)
- [MÃ³dulos](#-mÃ³dulos)
- [Requisitos Previos](#-requisitos-previos)
- [ConfiguraciÃ³n](#-configuraciÃ³n)
- [Despliegue](#-despliegue)
- [Jenkins Pipeline](#-jenkins-pipeline)

---

## ğŸ—ï¸ Arquitectura

### Componentes Principales

- **VPC** con subnets pÃºblica y privada
- **NAT Gateway** para acceso a Internet desde subnet privada
- **VPC Endpoints** (Gateway) para DynamoDB y S3
- **3 Funciones Lambda** en subnet privada
- **API Gateway HTTP** con integraciones Lambda
- **DynamoDB** (3 tablas)
- **S3** para frontend
- **Cognito User Pool** para autenticaciÃ³n

---

## ğŸ“ Estructura del Proyecto

```
IAC VALVERDE/
â”œâ”€â”€ main.tf                      # OrquestaciÃ³n principal (solo llama a mÃ³dulos)
â”œâ”€â”€ variables.tf                 # Variables globales
â”œâ”€â”€ outputs.tf                   # Outputs consolidados
â”œâ”€â”€ backend.tf                   # ConfiguraciÃ³n del backend remoto
â”œâ”€â”€ Jenkinsfile                  # Pipeline de CI/CD
â”‚
â”œâ”€â”€ modules/                     # MÃ³dulos reutilizables
â”‚   â”œâ”€â”€ vpc/                    # MÃ³dulo de red y VPC
â”‚   â”‚   â”œâ”€â”€ main.tf
â”‚   â”‚   â”œâ”€â”€ variables.tf
â”‚   â”‚   â””â”€â”€ outputs.tf
â”‚   â”‚
â”‚   â”œâ”€â”€ dynamodb/               # MÃ³dulo de DynamoDB
â”‚   â”‚   â”œâ”€â”€ main.tf
â”‚   â”‚   â”œâ”€â”€ variables.tf
â”‚   â”‚   â””â”€â”€ outputs.tf
â”‚   â”‚
â”‚   â”œâ”€â”€ s3/                     # MÃ³dulo de S3
â”‚   â”‚   â”œâ”€â”€ main.tf
â”‚   â”‚   â”œâ”€â”€ variables.tf
â”‚   â”‚   â””â”€â”€ outputs.tf
â”‚   â”‚
â”‚   â”œâ”€â”€ lambda/                 # MÃ³dulo de Lambda
â”‚   â”‚   â”œâ”€â”€ main.tf
â”‚   â”‚   â”œâ”€â”€ variables.tf
â”‚   â”‚   â””â”€â”€ outputs.tf
â”‚   â”‚
â”‚   â”œâ”€â”€ api-gateway/            # MÃ³dulo de API Gateway
â”‚   â”‚   â”œâ”€â”€ main.tf
â”‚   â”‚   â”œâ”€â”€ variables.tf
â”‚   â”‚   â””â”€â”€ outputs.tf
â”‚   â”‚
â”‚   â””â”€â”€ cognito/                # MÃ³dulo de Cognito
â”‚       â”œâ”€â”€ main.tf
â”‚       â”œâ”€â”€ variables.tf
â”‚       â””â”€â”€ outputs.tf
â”‚
â”œâ”€â”€ environments/               # Configuraciones por ambiente
â”‚   â”œâ”€â”€ dev/
â”‚   â”‚   â””â”€â”€ terraform.tfvars
â”‚   â””â”€â”€ prod/
â”‚       â””â”€â”€ terraform.tfvars
â”‚
â””â”€â”€ lambda-code-examples/       # CÃ³digo Lambda de ejemplo
    â”œâ”€â”€ subscription-control.js
    â”œâ”€â”€ access-control.js
    â”œâ”€â”€ notification-service.js
    â””â”€â”€ package.json
```

---

## ğŸ§© MÃ³dulos

### 1. MÃ³dulo VPC (`modules/vpc`)

**Responsabilidad**: GestiÃ³n de la red y conectividad

**Recursos creados**:
- VPC con DNS habilitado
- Internet Gateway
- Subnet PÃºblica con NAT Gateway
- Subnet Privada para Lambdas
- Route Tables configuradas
- VPC Endpoints para S3 y DynamoDB

**Variables principales**:
- `vpc_cidr`: CIDR de la VPC
- `public_subnet_cidr`: CIDR de subnet pÃºblica
- `private_subnet_cidr`: CIDR de subnet privada

---

### 2. MÃ³dulo DynamoDB (`modules/dynamodb`)

**Responsabilidad**: GestiÃ³n de tablas DynamoDB

**Recursos creados**:
- Tabla `usuarios` con Ã­ndice por email
- Tabla `pagos` con Ã­ndice por userId
- Tabla `historial-asistencia` con Ã­ndice por userId

**Variables principales**:
- `billing_mode`: Modo de facturaciÃ³n (PAY_PER_REQUEST o PROVISIONED)

---

### 3. MÃ³dulo S3 (`modules/s3`)

**Responsabilidad**: Almacenamiento del frontend

**Recursos creados**:
- Bucket S3 con versionado
- ConfiguraciÃ³n de website hosting
- EncriptaciÃ³n AES256
- Bloqueo de acceso pÃºblico

---

### 4. MÃ³dulo Lambda (`modules/lambda`)

**Responsabilidad**: Funciones serverless

**Recursos creados**:
- 3 Funciones Lambda en subnet privada
- Security Group para Lambdas
- IAM Roles y polÃ­ticas
- IntegraciÃ³n con DynamoDB

**Funciones**:
- `subscription-control`: GestiÃ³n de suscripciones
- `access-control`: Control de acceso y asistencia
- `notification-service`: EnvÃ­o de notificaciones

---

### 5. MÃ³dulo API Gateway (`modules/api-gateway`)

**Responsabilidad**: API HTTP pÃºblica

**Recursos creados**:
- HTTP API Gateway
- Integraciones con Lambdas
- Rutas configuradas
- CORS habilitado

**Endpoints**:
- `POST /subscription`
- `POST /access`
- `POST /notification`

---

### 6. MÃ³dulo Cognito (`modules/cognito`)

**Responsabilidad**: AutenticaciÃ³n de usuarios

**Recursos creados**:
- User Pool con polÃ­ticas de contraseÃ±a
- App Client configurado
- Dominio personalizado

---

## ğŸ“¦ Requisitos Previos

### Herramientas

```bash
# Terraform >= 1.0
terraform --version

# AWS CLI
aws --version

# Git
git --version
```

### Credenciales AWS

- Cuenta AWS activa
- IAM User con permisos de administrador
- Access Key y Secret Key configurados

---

## ğŸ”§ ConfiguraciÃ³n

### 1. Clonar el Repositorio

```bash
git clone <tu-repositorio>
cd "IAC VALVERDE"
```

### 2. Configurar Credenciales AWS

```bash
aws configure
```

### 3. Seleccionar Ambiente

```bash
# Copiar configuraciÃ³n del ambiente deseado
cp environments/dev/terraform.tfvars terraform.tfvars

# O para producciÃ³n
cp environments/prod/terraform.tfvars terraform.tfvars
```

### 4. Personalizar Variables (Opcional)

Editar `terraform.tfvars` segÃºn tus necesidades.

---

## ğŸš€ Despliegue

### Despliegue Local

```bash
# 1. Inicializar Terraform
terraform init

# 2. Validar configuraciÃ³n
terraform validate

# 3. Ver plan de ejecuciÃ³n
terraform plan

# 4. Aplicar cambios
terraform apply

# 5. Ver outputs
terraform output
```

### Despliegue con Script PowerShell

```powershell
# Ver opciones
.\deploy.ps1 -Action plan

# Inicializar
.\deploy.ps1 -Action init

# Aplicar cambios
.\deploy.ps1 -Action apply -Environment dev

# Con auto-approve (Â¡CUIDADO!)
.\deploy.ps1 -Action apply -AutoApprove
```

### Despliegue por Ambiente

```bash
# Desarrollo
terraform apply -var-file="environments/dev/terraform.tfvars"

# ProducciÃ³n
terraform apply -var-file="environments/prod/terraform.tfvars"
```

---

## ğŸ¤– Jenkins Pipeline

### ConfiguraciÃ³n de Jenkins

#### 1. Instalar Plugins

- **CloudBees AWS Credentials Plugin**
- **Pipeline Plugin**
- **Git Plugin**

#### 2. Configurar Credenciales AWS

1. `Manage Jenkins` â†’ `Manage Credentials`
2. `Add Credentials` â†’ `AWS Credentials`
3. ID: `aws-credentials`
4. Ingresar Access Key y Secret Key

#### 3. Crear Pipeline

1. `New Item` â†’ `Pipeline`
2. Nombre: `ElMundoFitness-IaC`
3. En configuraciÃ³n:
   - **Definition**: Pipeline script from SCM
   - **SCM**: Git
   - **Repository URL**: Tu repositorio
   - **Script Path**: `Jenkinsfile`

#### 4. Ejecutar Pipeline

1. `Build with Parameters`
2. Seleccionar:
   - **ACTION**: `plan` o `apply`
   - **ENVIRONMENT**: `dev` o `prod`
3. Click en `Build`

---

## ğŸ“Š Ventajas de la Arquitectura Modular

### âœ… ReutilizaciÃ³n

- MÃ³dulos reutilizables en otros proyectos
- FÃ¡cil compartir entre equipos

### âœ… Mantenibilidad

- CÃ³digo organizado y fÃ¡cil de mantener
- Cambios aislados por mÃ³dulo
- Testing independiente

### âœ… Escalabilidad

- FÃ¡cil agregar nuevos mÃ³dulos
- ComposiciÃ³n flexible de recursos

### âœ… Claridad

- Responsabilidades bien definidas
- Estructura intuitiva
- DocumentaciÃ³n implÃ­cita

### âœ… Versionado

- MÃ³dulos con control de versiones
- Rollback granular por mÃ³dulo

---

## ğŸ§ª Testing

### Validar MÃ³dulos Individuales

```bash
# Validar mÃ³dulo VPC
cd modules/vpc
terraform init
terraform validate

# Validar mÃ³dulo Lambda
cd ../lambda
terraform init
terraform validate
```

### Test de IntegraciÃ³n

```bash
# Plan sin aplicar
terraform plan -out=plan.tfplan

# Revisar plan
terraform show plan.tfplan
```

---

## ğŸ§¹ Limpieza

### Destruir Infraestructura

```bash
# Con confirmaciÃ³n
terraform destroy

# Sin confirmaciÃ³n (PELIGROSO)
terraform destroy -auto-approve

# Por ambiente especÃ­fico
terraform destroy -var-file="environments/dev/terraform.tfvars"
```

### Con Jenkins

1. Build with Parameters
2. **ACTION**: `destroy`
3. **ENVIRONMENT**: El ambiente a destruir
4. Confirmar en la aprobaciÃ³n manual

---

## ğŸ“ Buenas PrÃ¡cticas Implementadas

### âœ… SeparaciÃ³n por MÃ³dulos

Cada componente en su propio mÃ³dulo con responsabilidad Ãºnica.

### âœ… Variables Tipadas

Todas las variables con tipo y descripciÃ³n clara.

### âœ… Outputs Descriptivos

Outputs bien documentados para cada mÃ³dulo.

### âœ… Tags Consistentes

Tags aplicados consistentemente a todos los recursos.

### âœ… Ambientes Separados

Configuraciones independientes por ambiente (dev/prod).

### âœ… State Management

Backend configurado para state remoto en S3.

### âœ… Security

- Lambdas en subnet privada
- VPC Endpoints para servicios AWS
- Security Groups restrictivos
- Bucket S3 con acceso pÃºblico bloqueado

---

## ğŸ” Seguridad

### Estado Remoto (Backend)

Crear bucket y tabla para el estado:

```bash
# Bucket S3
aws s3api create-bucket \
  --bucket elmundo-fitness-terraform-state \
  --region us-east-1

# Versionado
aws s3api put-bucket-versioning \
  --bucket elmundo-fitness-terraform-state \
  --versioning-configuration Status=Enabled

# Tabla DynamoDB para locks
aws dynamodb create-table \
  --table-name terraform-state-lock \
  --attribute-definitions AttributeName=LockID,AttributeType=S \
  --key-schema AttributeName=LockID,KeyType=HASH \
  --billing-mode PAY_PER_REQUEST \
  --region us-east-1
```

Luego descomentar en `backend.tf`.

---

## ğŸ’° EstimaciÃ³n de Costos

| Recurso | Uso Mensual | Costo Aproximado |
|---------|-------------|------------------|
| NAT Gateway | 730 hrs | $32-45 |
| Lambda | 1M invocaciones | Free Tier |
| DynamoDB | PAY_PER_REQUEST | Free Tier |
| API Gateway | 1M requests | Free Tier |
| S3 | 5GB | ~$0.50 |
| CloudWatch Logs | 5GB | ~$2.50 |
| Data Transfer | Variable | ~$5-10 |
| **TOTAL** | | **~$40-60/mes** |

*Nota: NAT Gateway es el recurso mÃ¡s costoso. Para DEV considera usar VPC Endpoints exclusivamente.*

---

## ğŸ¤ Contribuciones

1. Fork el repositorio
2. Crea una rama: `git checkout -b feature/nueva-funcionalidad`
3. Commit: `git commit -am 'Agrega nueva funcionalidad'`
4. Push: `git push origin feature/nueva-funcionalidad`
5. Crea un Pull Request

---

## ğŸ“ Soporte

Para dudas o problemas:

- Revisar logs en CloudWatch
- Validar configuraciÃ³n: `terraform validate`
- Verificar permisos IAM
- Consultar documentaciÃ³n de mÃ³dulos

---

## âœ… Checklist de Despliegue

- [ ] AWS CLI configurado
- [ ] Terraform instalado
- [ ] Credenciales AWS configuradas
- [ ] Variables personalizadas en terraform.tfvars
- [ ] `terraform init` ejecutado
- [ ] `terraform plan` revisado
- [ ] `terraform apply` ejecutado
- [ ] Outputs verificados
- [ ] Endpoints API probados
- [ ] Jenkins configurado (opcional)
- [ ] Backend remoto configurado (producciÃ³n)

---

**Â¡Tu infraestructura modular y escalable de "El Mundo Fitness" estÃ¡ lista! ğŸ‰**
